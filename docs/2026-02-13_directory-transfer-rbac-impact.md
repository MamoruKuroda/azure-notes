# Azure サブスクリプションのディレクトリ移転 — ロール / ユーザーへの影響まとめ

> 作成日: 2026/02/13

## 全体像

```text
移転前ディレクトリ (ソース)                移転後ディレクトリ (ターゲット)
┌─────────────────────────┐           ┌─────────────────────────┐
│  ユーザー A (Owner)      │           │  ユーザー X             │
│  ユーザー B (Contributor)│  ──移転──▶│  ユーザー Y             │
│  グループ G (Reader)     │           │  グループ Z             │
│  カスタムロール定義       │           │                         │
│  マネージド ID           │           │  （何もない状態）        │
└─────────────────────────┘           └─────────────────────────┘
        ↑ すべて削除される                  ↑ すべて再作成が必要
```

---

## 1. ロール割り当て（RBAC）への影響

| 項目 | 影響 | 詳細 |
|------|------|------|
| **すべてのロール割り当て** | **完全削除** | Owner, Contributor, Reader 等、継承含めすべて消える |
| **カスタムロール定義** | **完全削除** | 定義自体が消失する |
| **復元可否** | **不可** | 移転後に元に戻すことはできない |
| **PIM（適格な割り当て）** | **無効化** | 適格・アクティブ問わず削除される |

## 2. ユーザー / プリンシパルへの影響

| プリンシパル種別 | 影響 |
|---|---|
| **ユーザー** | ソースディレクトリのユーザーへの割り当てが全削除。ターゲットのユーザーに改めて割り当てが必要 |
| **グループ** | 同上。ターゲットに対応するグループを用意し再割り当て |
| **サービスプリンシパル（アプリ登録）** | 割り当て削除。ターゲットで再登録 or マッピングが必要 |
| **システム割り当てマネージド ID** | **破損する**。無効化→再有効化が必要。その後ロール再割り当て |
| **ユーザー割り当てマネージド ID** | **破損する**。削除→再作成→リソースに再アタッチ→ロール再割り当て |

## 3. 移転直後の「誰もアクセスできない」問題

```text
移転完了
    │
    ▼
サブスクリプションのロール割り当て = ゼロ
    │
    ▼
ターゲットディレクトリのユーザーが操作しようとする
    │
    ▼
❌ 「リソース グループを作成するためのアクセス許可がありません」
    │
    ▼
対処: グローバル管理者が「Azure リソースのアクセス管理」を有効化
    │
    ▼
ルートスコープ (/) で「ユーザーアクセス管理者」ロールを自己付与
    │
    ▼
必要なユーザーに Owner / Contributor を割り当て
    │
    ▼
✅ 通常運用に復帰
```

### 復旧手順

1. **グローバル管理者** で Azure ポータルにサインイン
2. **[Microsoft Entra ID] > [管理] > [プロパティ]** に移動
3. **[Azure リソースのアクセス管理]** を **「はい」** に切り替え → **[保存]**
4. サインアウト → 再サインイン
5. サブスクリプションの **[アクセス制御 (IAM)]** で必要なユーザーに **Owner** / **Contributor** を割り当て
6. 完了後、**[Azure リソースのアクセス管理]** を **「いいえ」** に戻す（セキュリティ上必須）

## 4. その他影響を受けるリソース

| リソース | 移転可否 | 必要な対応 |
|---|---|---|
| **Key Vault** | ○ | テナント ID 更新 + アクセスポリシー再作成 |
| **Azure SQL（Entra認証有効）** | **✕ 移転不可** | — |
| **AKS** | **✕ 移転不可** | — |
| **Azure Databricks** | **✕ 移転不可** | — |
| **Storage / Data Lake Gen2** | ○ | ACL 再作成 |
| **Azure Files** | ○（条件付き） | ACL 再作成 + Kerberos認証の再設定 |
| **Managed Disks（CMK暗号化）** | ○ | ディスク暗号化セットの ID 再有効化 + Key Vault 権限再付与 |
| **Azure Policy** | ○ | エクスポート→インポート→再割り当て |
| **Entra Domain Services** | **✕ 移転不可** | — |
| **Dev Box / Deployment Environments** | **✕ 移転不可** | — |
| **Service Fabric** | **✕ 移転不可** | クラスター再作成 |

## 5. 移転前にやるべきことチェックリスト

| # | 作業 | コマンド例 |
|---|---|---|
| 1 | ロール割り当てをエクスポート | `az role assignment list --all --include-inherited -o json > roles.json` |
| 2 | カスタムロール定義をエクスポート | `az role definition list --custom-role-only true -o json` |
| 3 | マネージド ID の一覧を取得 | `az ad sp list --all --filter "servicePrincipalType eq 'ManagedIdentity'"` |
| 4 | Key Vault のアクセスポリシーを記録 | `az keyvault show --name <name>` |
| 5 | ソース↔ターゲットのユーザーマッピング表を作成 | 手動 |
| 6 | 移転不可リソースの有無を確認 | Resource Graph クエリ |

## 6. 移転後にやるべきことチェックリスト

| # | 作業 |
|---|---|
| 1 | **グローバル管理者で「Azure リソースのアクセス管理」を有効化**（最重要） |
| 2 | ターゲットのユーザーに Owner / Contributor を割り当て |
| 3 | カスタムロールを再作成 |
| 4 | すべてのロール割り当てを再作成 |
| 5 | マネージド ID を無効化→再有効化（システム割り当て） / 削除→再作成（ユーザー割り当て） |
| 6 | Key Vault のテナント ID 更新 + アクセスポリシー再作成 |
| 7 | ストレージ ACL の再設定 |
| 8 | アクセスキー・シークレット・証明書のローテーション |
| 9 | **「Azure リソースのアクセス管理」を「いいえ」に戻す**（セキュリティ上必須） |

---

## 参考リンク

- [Azure サブスクリプションを別の Microsoft Entra ディレクトリに移転する](https://learn.microsoft.com/ja-jp/azure/role-based-access-control/transfer-subscription)
- [Azure のすべてのサブスクリプションと管理グループを管理する目的でアクセス権限を昇格させる](https://learn.microsoft.com/ja-jp/azure/role-based-access-control/elevate-access-global-admin)

---

> **一言まとめ:** ディレクトリ移転は「サブスクリプションの中身（リソース）は残るが、誰がどの権限で触れるかという情報は全部消える」操作。移転後に最初にぶつかる壁が「そもそも権限を割り当てる権限がない」問題であり、その唯一の突破口がグローバル管理者による **「Azure リソースのアクセス管理」トグル** である。
