# 2026/02/13 PIM で Owner を「アクティブな永続的」にする手順とトラブルシューティング

## 1. 背景

Azure サブスクリプションのディレクトリ移転後、すべての RBAC ロール割り当てが削除される。グローバル管理者で「Azure リソースのアクセス管理」を有効化して権限を取り戻しても、PIM（Privileged Identity Management）管理下のサブスクリプションでは追加の手順が必要になる。

本ドキュメントでは、特定アカウントに Owner を **「アクティブな永続的」** として割り当てるまでの手順と、途中で遭遇するエラーの対処法をまとめる。

---

## 2. ゴール

- 対象アカウントに対して、サブスクリプションスコープで Owner を **「アクティブな永続的な割り当て」** として設定する
- PIM のアクティブ化（一時的な昇格）を毎回行う必要をなくす

---

## 3. 手順

### 3-1. グローバル管理者で「Azure リソースのアクセス管理」を有効化

1. **グローバル管理者** で Azure Portal にサインイン
2. **[Microsoft Entra ID]** → **[プロパティ]**
3. **[Azure リソースのアクセス管理]** → **「はい」** → **[保存]**
4. **サインアウト → 再サインイン**（トークン更新のため必須）

> これにより、ルートスコープ (/) で **User Access Administrator** ロールが自動付与される。

### 3-2. PIM のロール設定で永続的アクティブ割り当てを許可する

デフォルトでは「許可される最大の割り当て期間は **6 月**」に設定されており、**「永続的にアクティブ」チェックボックスが表示されない**。

1. **[Privileged Identity Management]** → **[Azure リソース]** → 対象サブスクリプション選択
2. **[設定]** → ロール一覧から **「所有者」** をクリック
3. 上部の **[編集]** をクリック
4. **[割り当て]** タブを開く
5. **「永続的にアクティブな割り当てを許可する」** にチェックを入れる
6. **[更新]**

### 3-3. 既存の「適格」割り当てを削除する

同一スコープ・同一ロール・同一ユーザーに「適格」が存在する状態で「アクティブ」を追加しようとすると、以下のエラーが発生する：

```
❌ "The Role assignment already exists."
```

**対処:**

1. **[PIM]** → **[Azure リソース]** → サブスクリプション → **[割り当て]**
2. **「資格のある割り当て」** タブを開く
3. 対象ユーザーの Owner 行で **[...]** → **[削除]**
4. 反映を待つ（数秒〜1 分）

### 3-4. 「アクティブ（永続的）」で再追加する

1. **[割り当ての追加]** をクリック
2. ロール: **所有者** を選択
3. メンバー: 対象アカウントを選択 → **[次へ]**
4. **設定** タブで：
   - **割り当ての種類** → **「アクティブ」** を選択
   - **「永続的にアクティブ」** にチェック
5. 理由を入力 → **[割り当て]**

### 3-5. 反映を待つ（再サインインが必要）

PIM の割り当て変更は **即座に反映されない**（数十秒〜数分かかる）。

また、ブラウザのセッションが古い権限情報のままになっているため：

1. Azure Portal から **サインアウト**
2. ブラウザを **一度閉じる**（または InPrivate / シークレットウィンドウで開く）
3. **再サインイン**

> **確認方法:** サブスクリプション → [アクセス制御 (IAM)] → [アクセスの確認] で対象ユーザーを検索し、**「アクティブな永続的な割り当て」** に Owner が表示されることを確認する。

### 3-6. 「Azure リソースのアクセス管理」を「いいえ」に戻す

**セキュリティ上必須。** Owner が永続アクティブになったら、昇格トグルは不要。

1. **[Microsoft Entra ID]** → **[プロパティ]**
2. **[Azure リソースのアクセス管理]** → **「いいえ」** → **[保存]**

> 戻さないまま放置すると、IAM に「お使いのテナントでは、N 人のユーザーが昇格されたアクセス権を持っています」という警告が表示され続ける。

---

## 4. よくあるエラーと対処

| エラー / 症状 | 原因 | 対処 |
|---|---|---|
| `The Role assignment already exists.` | 同じスコープに「適格」が既に存在する | 適格を先に削除してからアクティブで再追加 |
| 「永続的にアクティブ」が表示されない | PIM のロール設定で許可されていない | [設定] → [所有者] → [編集] で許可する（手順 3-2） |
| リソースグループ作成で「アクセス許可がありません」 | トークンキャッシュが古い | サインアウト → ブラウザ閉じる → 再サインイン |
| IAM の [アクセスの確認] で Owner が見えない | 「資格のある割り当て」タブを見ている | **「アクティブな割り当て」** タブに切り替える |
| PIM で割り当て直後にリストに表示されない | 反映に時間がかかる | 数分待ってからページを更新 |
| 「アクションが必要です: N 人のユーザーが昇格されたアクセス権を持っています」 | 「Azure リソースのアクセス管理」が「はい」のまま | 「いいえ」に戻す（手順 3-6） |

---

## 5. PIM 割り当て vs IAM 直接割り当ての違い

| 項目 | PIM（アクティブな永続的） | IAM 直接割り当て |
|---|---|---|
| 監査ログ | PIM 監査に記録される | Azure アクティビティログのみ |
| 承認フロー | 設定可能 | なし |
| アクセスレビュー | 対象になる | 対象外 |
| 有効化タイミング | 即時（アクティブの場合） | 即時 |
| 表示場所 | PIM + IAM 両方 | IAM のみ |

> PIM が面倒な場合、IAM の **[+ 追加]** → **[ロールの割り当ての追加]** から直接 Owner を割り当てることも可能。ただし PIM の監査・承認フローが適用されない点に注意。

---

## 6. 注意事項

- **「Azure リソースのアクセス管理」トグル**は作業後に**必ず「いいえ」に戻す**こと
- User Access Administrator（ルート継承）が残っていると、IAM に警告バナーが表示される
- PIM の割り当て変更後は**必ず再サインイン**すること（トークンキャッシュの影響）
- ディレクトリ移転後は RBAC だけでなく、**Compute クォータ**もリセットされる可能性がある（別途引き上げ申請が必要）

---

## 参考リンク

- [Azure PIM を使用して Azure リソース ロールを割り当てる](https://learn.microsoft.com/ja-jp/entra/id-governance/privileged-identity-management/pim-resource-roles-assign-roles)
- [PIM で Azure リソース ロールの設定を構成する](https://learn.microsoft.com/ja-jp/entra/id-governance/privileged-identity-management/pim-resource-roles-configure-role-settings)
- [Azure のすべてのサブスクリプションと管理グループを管理する目的でアクセス権限を昇格させる](https://learn.microsoft.com/ja-jp/azure/role-based-access-control/elevate-access-global-admin)
- [Azure サブスクリプションを別の Microsoft Entra ディレクトリに移転する](https://learn.microsoft.com/ja-jp/azure/role-based-access-control/transfer-subscription)
